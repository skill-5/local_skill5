{"version":3,"file":"landing_handshake.min.js","sources":["../src/landing_handshake.js"],"sourcesContent":["/**\n * Landing page handshake module for Skill5 integration.\n *\n * @module     local_skill5/landing_handshake\n * @copyright  2025 Skill5\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n/**\n * Initialize the handshake listener for Skill5 iframe communication.\n *\n * @param {string} skill5Origin The origin URL of the Skill5 platform\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nexport const init = (skill5Origin, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Handshake listener is active.');\n\n    window.addEventListener('message', (event) => {\n        if (event.origin !== skill5Origin) {\n            window.console.warn('[Moodle] Message from unexpected origin ignored:', event.origin);\n            return;\n        }\n\n        const message = event.data;\n        window.console.log('[Moodle] Received message:', message);\n\n        if (message && message.type) {\n            switch (message.type) {\n                case 'SKILL5_IFRAME_READY':\n                    window.console.log('[Moodle] Received SKILL5_IFRAME_READY. Sending acknowledgment...');\n                    event.source.postMessage({type: 'MOODLE_LISTENER_READY'}, event.origin);\n                    break;\n\n                case 'SKILL5_SEND_EMAIL':\n                    if (message.payload && message.payload.email) {\n                        handleEmailPayload(message.payload.email, connectUrl, connectionAssistantUrl);\n                    } else {\n                        window.console.error('[Moodle] Email payload is missing or invalid:', message.payload);\n                    }\n                    break;\n            }\n        }\n    });\n};\n\n/**\n * Handle the email payload from Skill5 iframe.\n *\n * @param {string} adminEmail The admin email received from Skill5\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nconst handleEmailPayload = (adminEmail, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Received email payload:', adminEmail);\n    window.console.log('[Moodle] Calling connect.php via fetch...');\n\n    const url = `${connectUrl}?email=${encodeURIComponent(adminEmail)}`;\n\n    fetch(url, {\n        method: 'GET',\n        credentials: 'same-origin'\n    })\n    .then(response => {\n        window.console.log('[Moodle] Connect.php response received');\n        if (response.ok) {\n            window.console.log('[Moodle] Redirecting to connection_assistant.php');\n            window.location.href = connectionAssistantUrl;\n        } else {\n            window.console.error('[Moodle] Connect.php returned error:', response.status);\n            Notification.alert(\n                'Connection Error',\n                'Connection failed. Please try again or contact support.',\n                'OK'\n            );\n        }\n    })\n    .catch(error => {\n        window.console.error('[Moodle] Error calling connect.php:', error);\n        Notification.alert(\n            'Connection Error',\n            'Connection failed. Please try again or contact support.',\n            'OK'\n        );\n    });\n};\n"],"names":["exports","init","skill5Origin","connectUrl","connectionAssistantUrl","window","console","log","addEventListener","event","origin","message","data","type","source","postMessage","payload","email","handleEmailPayload","error","warn","adminEmail","url","concat","encodeURIComponent","fetch","method","credentials","then","response","ok","location","href","status","Notification","alert"],"mappings":";;;;;;;KAkBiBA,QAAJC,KAAO,SAACC,aAAcC,WAAYC,wBAC3CC,OAAOC,QAAQC,IAAI,0CAEnBF,OAAOG,iBAAiB,UAAW,SAACC,OAChC,GAAIA,MAAMC,SAAWR,aAArB,CAKA,IAAMS,QAAUF,MAAMG,KAGtB,GAFAP,OAAOC,QAAQC,IAAI,6BAA8BI,SAE7CA,SAAWA,QAAQE,KACnB,OAAQF,QAAQE,MACZ,IAAK,sBACDR,OAAOC,QAAQC,IAAI,oEACnBE,MAAMK,OAAOC,YAAY,CAACF,KAAM,yBAA0BJ,MAAMC,QAChE,MAEJ,IAAK,oBACGC,QAAQK,SAAWL,QAAQK,QAAQC,MACnCC,mBAAmBP,QAAQK,QAAQC,MAAOd,WAAYC,wBAEtDC,OAAOC,QAAQa,MAAM,gDAAiDR,QAAQK,SAhB9F,MAFIX,OAAOC,QAAQc,KAAK,mDAAoDX,MAAMC,OAuBtF,IA5BG,IAsCDQ,mBAAqB,SAACG,WAAYlB,WAAYC,wBAChDC,OAAOC,QAAQC,IAAI,mCAAoCc,YACvDhB,OAAOC,QAAQC,IAAI,6CAEnB,IAAMe,IAAG,GAAAC,OAAMpB,WAAU,WAAAoB,OAAUC,mBAAmBH,aAEtDI,MAAMH,IAAK,CACPI,OAAQ,MACRC,YAAa,gBAEhBC,KAAK,SAAAC,UACFxB,OAAOC,QAAQC,IAAI,0CACfsB,SAASC,IACTzB,OAAOC,QAAQC,IAAI,oDACnBF,OAAO0B,SAASC,KAAO5B,yBAEvBC,OAAOC,QAAQa,MAAM,uCAAwCU,SAASI,QACtEC,eAAY,QAACC,MACT,mBACA,0DACA,MAGZ,GAAE,MACK,SAAAhB,OACHd,OAAOC,QAAQa,MAAM,sCAAuCA,OAC5De,eAAY,QAACC,MACT,mBACA,0DACA,KAER,GACF"}