{"version":3,"file":"landing_handshake.js","sources":["../src/landing_handshake.js"],"sourcesContent":["/**\n * Landing page handshake module for Skill5 integration.\n *\n * @module     local_skill5/landing_handshake\n * @copyright  2025 Skill5\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n/**\n * Initialize the handshake listener for Skill5 iframe communication.\n *\n * @param {string} skill5Origin The origin URL of the Skill5 platform\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nexport const init = (skill5Origin, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Handshake listener is active.');\n\n    window.addEventListener('message', (event) => {\n        if (event.origin !== skill5Origin) {\n            window.console.warn('[Moodle] Message from unexpected origin ignored:', event.origin);\n            return;\n        }\n\n        const message = event.data;\n        window.console.log('[Moodle] Received message:', message);\n\n        if (message && message.type) {\n            switch (message.type) {\n                case 'SKILL5_IFRAME_READY':\n                    window.console.log('[Moodle] Received SKILL5_IFRAME_READY. Sending acknowledgment...');\n                    event.source.postMessage({type: 'MOODLE_LISTENER_READY'}, event.origin);\n                    break;\n\n                case 'SKILL5_SEND_EMAIL':\n                    if (message.payload && message.payload.email) {\n                        handleEmailPayload(message.payload.email, connectUrl, connectionAssistantUrl);\n                    } else {\n                        window.console.error('[Moodle] Email payload is missing or invalid:', message.payload);\n                    }\n                    break;\n            }\n        }\n    });\n};\n\n/**\n * Handle the email payload from Skill5 iframe.\n *\n * @param {string} adminEmail The admin email received from Skill5\n * @param {string} connectUrl The URL to connect.php\n * @param {string} connectionAssistantUrl The URL to connection_assistant.php\n */\nconst handleEmailPayload = (adminEmail, connectUrl, connectionAssistantUrl) => {\n    window.console.log('[Moodle] Received email payload:', adminEmail);\n    window.console.log('[Moodle] Calling connect.php via fetch...');\n\n    const url = `${connectUrl}?email=${encodeURIComponent(adminEmail)}`;\n\n    fetch(url, {\n        method: 'GET',\n        credentials: 'same-origin'\n    })\n    .then(response => {\n        window.console.log('[Moodle] Connect.php response received');\n        if (response.ok) {\n            window.console.log('[Moodle] Redirecting to connection_assistant.php');\n            window.location.href = connectionAssistantUrl;\n        } else {\n            window.console.error('[Moodle] Connect.php returned error:', response.status);\n            Notification.alert(\n                'Connection Error',\n                'Connection failed. Please try again or contact support.',\n                'OK'\n            );\n        }\n    })\n    .catch(error => {\n        window.console.error('[Moodle] Error calling connect.php:', error);\n        Notification.alert(\n            'Connection Error',\n            'Connection failed. Please try again or contact support.',\n            'OK'\n        );\n    });\n};\n"],"names":["init","exports","skill5Origin","connectUrl","connectionAssistantUrl","window","console","log","addEventListener","event","origin","warn","message","data","type","source","postMessage","payload","email","handleEmailPayload","error","adminEmail","url","concat","encodeURIComponent","fetch","method","credentials","then","response","ok","location","href","status","Notification","alert"],"mappings":"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"}